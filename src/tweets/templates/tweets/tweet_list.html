{% extends 'base.html' %}
{% block title %} List {% endblock title %}

{% block script  %}
<script type="text/javascript">

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}

$(document).ready(function(){
	
var query = getParameterByName('q')
// console.log(query)
var tweetList = []

function parseTweets(){
	if (tweetList==0) {
		$('#tweet-container').text('No tweets currently found.')
	} 
	else { // tweets exists parse and display them
	$.each(tweetList, function(key,value){
		var tweetUser = key;
		var tweetUser = value.user;
		var tweetContent = value.content;
		$('#tweet-container').append(
			"<div class=\"media\"> <div class=\"media-body\">" +
				tweetContent + "<br> via " +
				tweetUser.username + " | " +
				"<a href='#'>View</a>" +
			"</div> </div> <hr>"
			)	
		})
	}
}

function fetchTweets() {
	console.log('fetching...')
	$.ajax({
		url: '/api/tweet/',
		data: {
			'q': query
		},
		method: 'GET',
		success: function (data) {
				tweetList = data
				parseTweets()
		},
		error: function (data) {
			console.log('error')
			console.log(data)
		}	
	})
}
fetchTweets()	

$('#tweet-form').submit(function(event){
	event.preventDefault()
	// console.log(event)
	var formData =  $(this).serialize()
	$.ajax({
		url: '/api/tweet/create/',
		data: formData,
		method: 'POST',
		success: function (data) {
				// tweetList = data
				// parseTweets()
				console.log(data)
				fetchTweets()
		},
		error: function (data) {
			console.log('error')
			console.log(data.status)
			console.log(data.statusText)
		}	
	})
})
})

</script>

{% endblock script %}

{% block body %}


<div class="container">
	{% if not request.GET.q %}
	<div class="row">
		{% include 'tweets/form.html' with form=create_form action_url=create_url btn_title="Tweet" form_id="tweet-form" %}
	</div>
	{% endif %}
	<hr>

	<div id="tweet-container">
		
	</div>

</div>
{% endblock body %}
